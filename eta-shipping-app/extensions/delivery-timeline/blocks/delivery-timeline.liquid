{% comment %}
  Delivery Timeline Block - Direct Metaobject Query
{% endcomment %}

{{ 'delivery-timeline.css' | asset_url | stylesheet_tag }}

{% comment %} Query metaobject timelines {% endcomment %}
{% assign metaobject_timelines = shop.metaobjects.delivery_timeline_rule.values | first %}

{% comment %} Get product collection IDs {% endcomment %}
{% assign product_collection_ids = product.collections | map: 'id' %}

{% comment %} Find matching timeline {% endcomment %}
{% assign matched_timeline = null %}

{% if metaobject_timelines and metaobject_timelines.timelines %}
  {% assign all_timelines = metaobject_timelines.timelines.value  %}
  
  {% for timeline in all_timelines %}
    {% assign found_match = false %}
    
    {% for collection_gid in timeline.collections %}
      {% assign collection_id = collection_gid | split: '/' | last | plus: 0 %}
      
      {% if product_collection_ids contains collection_id %}
        {% assign matched_timeline = timeline %}
        {% assign found_match = true %}
        {% break %}
      {% endif %}
    {% endfor %}
    
    {% if found_match %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="eta-delivery-wrapper" data-product-id="{{ product.id }}">
  {% if matched_timeline %}
    <!-- Main content -->
    <div class="eta-content">
        <div class="eta-header">
            <!-- Thay SVG bằng img -->
            <img src="{{ 'us.svg' | asset_url }}" alt="US Flag" class="eta-flag-icon" width="20" height="20">
            
            <div class="eta-header-text">
              <!-- Delivery to và Country cùng dòng -->
              <div class="eta-delivery-to">
                Delivery to 
                <span class="eta-country">United States</span>
              </div>
            </div>
          </div>
          

      <div class="eta-shipping-section">
        {% comment %} <div class="eta-shipping-label">{{ block.settings.shipping_label | default: 'Shipping' }}</div> {% endcomment %}
        <div class="eta-shipping-text">
          Order today and get it by: 
          <span class="eta-date-range" id="eta-date-trigger">
            <span class="eta-delivery-dates" 
                  data-delivery-from="{{ matched_timeline.deliveryFrom }}" 
                  data-delivery-to="{{ matched_timeline.deliveryTo }}">
            </span>
          </span>
        </div>
      </div>

      <!-- Popup -->
      <div id="eta-popup" class="eta-popup">
        <div class="eta-popup-timeline">
          <div class="eta-timeline-line"></div>
          
          <!-- Order placed icon -->
          <div class="eta-timeline-icon eta-icon-left">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path fill="#000" d="M23 17C23 20.31 20.31 23 17 23V21.5C19.5 21.5 21.5 19.5 21.5 17H23M1 7C1 3.69 3.69 1 7 1V2.5C4.5 2.5 2.5 4.5 2.5 7H1M8 4.32L3.41 8.92C.19 12.14 .19 17.37 3.41 20.59S11.86 23.81 15.08 20.59L22.15 13.5C22.64 13.03 22.64 12.24 22.15 11.75C21.66 11.26 20.87 11.26 20.38 11.75L15.96 16.17L15.25 15.46L21.79 8.92C22.28 8.43 22.28 7.64 21.79 7.15S20.5 6.66 20 7.15L14.19 13L13.5 12.27L20.37 5.38C20.86 4.89 20.86 4.1 20.37 3.61S19.09 3.12 18.6 3.61L11.71 10.5L11 9.8L16.5 4.32C17 3.83 17 3.04 16.5 2.55S15.22 2.06 14.73 2.55L7.11 10.17C8.33 11.74 8.22 14 6.78 15.45L6.07 14.74C7.24 13.57 7.24 11.67 6.07 10.5L5.72 10.15L9.79 6.08C10.28 5.59 10.28 4.8 9.79 4.31C9.29 3.83 8.5 3.83 8 4.32Z"/>
            </svg>
          </div>

          <!-- Shipping icon -->
          <div class="eta-timeline-icon eta-icon-center">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path fill="#000" d="M3,13.5L2.25,12H7.5L6.9,10.5H2L1.25,9H9.05L8.45,7.5H1.11L0.25,6H4A2,2 0 0,1 6,4H18V8H21L24,12V17H22A3,3 0 0,1 19,20A3,3 0 0,1 16,17H12A3,3 0 0,1 9,20A3,3 0 0,1 6,17H4V13.5H3M19,18.5A1.5,1.5 0 0,0 20.5,17A1.5,1.5 0 0,0 19,15.5A1.5,1.5 0 0,0 17.5,17A1.5,1.5 0 0,0 19,18.5M20.5,9.5H18V12H22.46L20.5,9.5M9,18.5A1.5,1.5 0 0,0 10.5,17A1.5,1.5 0 0,0 9,15.5A1.5,1.5 0 0,0 7.5,17A1.5,1.5 0 0,0 9,18.5Z"/>
            </svg>
          </div>

          <!-- Delivered icon -->
          <div class="eta-timeline-icon eta-icon-right">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path fill="#000" d="M9.06,1.93C7.17,1.92 5.33,3.74 6.17,6H3A2,2 0 0,0 1,8V10A1,1 0 0,0 2,11H11V8H13V11H22A1,1 0 0,0 23,10V8A2,2 0 0,0 21,6H17.83C19,2.73 14.6,0.42 12.57,3.24L12,4L11.43,3.22C10.8,2.33 9.93,1.94 9.06,1.93M9,4C9.89,4 10.34,5.08 9.71,5.71C9.08,6.34 8,5.89 8,5A1,1 0 0,1 9,4M15,4C15.89,4 16.34,5.08 15.71,5.71C15.08,6.34 14,5.89 14,5A1,1 0 0,1 15,4M2,12V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V12H13V20H11V12H2Z"/>
            </svg>
          </div>
        </div>

        <div class="eta-popup-dates">
          <div class="eta-date-col eta-date-left">
            <div class="eta-date-value eta-order-placed"></div>
            <div class="eta-date-label">Order placed</div>
          </div>
          <div class="eta-date-col eta-date-center">
            <div class="eta-date-value eta-order-ship" 
                 data-ship-from="{{ matched_timeline.shippingFrom }}" 
                 data-ship-to="{{ matched_timeline.shippingTo }}">
            </div>
            <div class="eta-date-label">Order ship</div>
          </div>
          <div class="eta-date-col eta-date-right">
            <div class="eta-date-value eta-order-delivered" 
                 data-delivery-from="{{ matched_timeline.deliveryFrom }}" 
                 data-delivery-to="{{ matched_timeline.deliveryTo }}">
            </div>
            <div class="eta-date-label">Delivered!</div>
          </div>
        </div>

        {% comment %} <div class="eta-popup-notes">
          <ul>
            <li>Orders can be cancelled or modified within 2 hours after being placed.</li>
            <li>The above time frame is applied with standard shipping methods.</li>
          </ul>
        </div> {% endcomment %}
      </div>
    </div>

<script>

(function () {
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }
  

  const wrapper = document.querySelector('.eta-delivery-wrapper');
  if (!wrapper) return;

  // Elements
  const deliveryDatesEl = wrapper.querySelector('.eta-delivery-dates');
  const orderShipEl = wrapper.querySelector('.eta-order-ship');
  const orderDeliveredEl = wrapper.querySelector('.eta-order-delivered');
  const orderPlacedEl = wrapper.querySelector('.eta-order-placed');

  if (!deliveryDatesEl || !orderShipEl || !orderDeliveredEl || !orderPlacedEl) {
      console.error("ETA Timeline: One or more required elements not found.");
      return;
  }

  // Data from metaobjects, with user's logic as a fallback
  const handlingFrom = parseInt(orderShipEl.dataset.shipFrom || '1', 10);
  const handlingTo   = parseInt(orderShipEl.dataset.shipTo || '2', 10);
  const deliveryFrom = parseInt(deliveryDatesEl.dataset.deliveryFrom || '5', 10);
  const deliveryTo   = parseInt(deliveryDatesEl.dataset.deliveryTo || '7', 10);

  /* =====================
     Helpers
  ====================== */
  
  /**
   * Adds a specified number of business days to a date, skipping Saturdays and Sundays.
   * @param {Date} startDate - The starting date.
   * @param {number} days - The number of business days to add.
   * @returns {Date} - The resulting date.
   */
  function addBusinessDays(startDate, days) {
    // Return a copy of the start date if no days are added
    const date = new Date(startDate.valueOf());
    if (days === 0) return date;

    let addedDays = 0;
    while (addedDays < days) {
      date.setDate(date.getDate() + 1);
      const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
      if (dayOfWeek !== 0 && dayOfWeek !== 6) {
        addedDays++;
      }
    }
    return date;
  }

  /* =====================
     Calculate ETA
  ===================== */
  const MOCK_TODAY = getQueryParam('eta_mock');
  const today = MOCK_TODAY ? new Date(MOCK_TODAY) : new Date();
  

  const orderDate = new Date(today);

  // 1. Calculate Ship Date Range (using business days for handling)
  const shipStartDate = addBusinessDays(orderDate, handlingFrom);
  const shipEndDate   = addBusinessDays(orderDate, handlingTo);

  function addCalendarDays(startDate, days) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + days);
    return date;
  }
  
  const deliveryStartDate = addCalendarDays(shipStartDate, deliveryFrom);
  const deliveryEndDate   = addCalendarDays(shipEndDate, deliveryTo);

  /* =====================
     Format & Render
  ====================== */
  const formatDate = (date) =>
    date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

  const formatRange = (start, end) =>
    `${formatDate(start)} - ${formatDate(end)}`;

  orderPlacedEl.textContent = formatDate(orderDate);
  orderShipEl.textContent = formatRange(shipStartDate, shipEndDate);
  deliveryDatesEl.textContent = formatRange(deliveryStartDate, deliveryEndDate);
  orderDeliveredEl.textContent = formatRange(deliveryStartDate, deliveryEndDate);

  /* =====================
     Popup
  ====================== */
  const trigger = wrapper.querySelector('#eta-date-trigger');
  const popup = wrapper.querySelector('#eta-popup');

  if (trigger && popup) {
    trigger.addEventListener('mouseenter', () => {
      popup.classList.add('eta-popup-visible');
    });

    trigger.addEventListener('mouseleave', () => {
      setTimeout(() => {
        if (!popup.matches(':hover')) {
          popup.classList.remove('eta-popup-visible');
        }
      }, 100);
    });

    popup.addEventListener('mouseleave', () => {
      popup.classList.remove('eta-popup-visible');
    });
  }
})();

</script>

  {% else %}
    <!-- No timeline found -->
    <div class="eta-no-data">
      <p>No delivery information available for this product.</p>
    </div>
  {% endif %}
</div>

 {% schema %}
{
  "name": "Delivery Timeline",
  "target": "section"

}
{% endschema %} 
